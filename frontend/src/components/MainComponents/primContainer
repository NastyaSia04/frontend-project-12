import React, { useEffect, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { useDispatch, useSelector } from 'react-redux'
import Modal from '../../components/MainComponents/Modal'
import AddChannelModal from '../../components/MainComponents/AddChannelModal'
import { closeModal } from '../../store/entities/uiSlice'
import { addChannelAsync } from '../../store/entities/channelsSlice'

const AddModal = () => {
  const dispatch = useDispatch()
  const existingNames = useSelector(state => 
    state.channels.list.map(channel => channel.name)
  )

  const handleClose = useCallback(() => {
    dispatch(closeModal())
  }, [dispatch])

  const handleSubmit = useCallback(async (name) => {
    try {
      await dispatch(addChannelAsync(name)).unwrap()
    } catch (err) {
      console.error('Ошибка при добавлении канала:', err)
    }
  }, [dispatch])

  useEffect(() => {
    const handleEscape = (e) => e.key === 'Escape' && handleClose()
    document.addEventListener('keydown', handleEscape)
    return () => document.removeEventListener('keydown', handleEscape)
  }, [handleClose])

  return createPortal(
    <Modal title="Добавить канал" onClose={handleClose}>
      <AddChannelModal 
        onHide={handleClose}
        onSubmit={handleSubmit}
        existingNames={existingNames}
      />
    </Modal>,
    document.body
  )
}

export default AddModal